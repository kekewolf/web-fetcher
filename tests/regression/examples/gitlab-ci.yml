# GitLab CI Configuration for Regression Tests
# GitLab CI 回归测试配置
#
# Usage: Copy to .gitlab-ci.yml or include in existing pipeline
# 用法：复制到 .gitlab-ci.yml 或包含在现有管道中

stages:
  - test
  - report
  - baseline

# Default settings
# 默认设置
default:
  image: python:3.9
  before_script:
    - pip install -r requirements.txt

# Cache dependencies
# 缓存依赖
cache:
  paths:
    - .pip-cache/
  key:
    files:
      - requirements.txt

# Quick smoke test - runs on every commit
# 快速冒烟测试 - 每次提交都运行
smoke_test:
  stage: test
  script:
    - |
      python scripts/run_regression_suite.py \
        --tags fast,reference \
        --report markdown \
        --output smoke-test-report.md
  artifacts:
    paths:
      - smoke-test-report.md
    expire_in: 1 week
    when: always

# Full regression test - runs on merge requests
# 完整回归测试 - 在合并请求时运行
full_regression:
  stage: test
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  script:
    - |
      # Download baseline if exists
      if [ -f tests/regression/baselines/main.json ]; then
        python scripts/run_regression_suite.py \
          --exclude-tags manual,slow \
          --baseline baselines/main.json \
          --fail-on-regression \
          --report markdown \
          --output regression-report.md
      else
        python scripts/run_regression_suite.py \
          --exclude-tags manual,slow \
          --report markdown \
          --output regression-report.md
      fi
  artifacts:
    paths:
      - regression-report.md
    reports:
      junit: regression-report.json
    expire_in: 30 days
    when: always
  allow_failure: false

# Platform-specific tests
# 平台特定测试
.platform_test_template:
  stage: test
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  artifacts:
    paths:
      - "*-report.md"
    expire_in: 1 week

wechat_test:
  extends: .platform_test_template
  script:
    - |
      python scripts/run_regression_suite.py \
        --tags wechat \
        --verbose \
        --report markdown \
        --output wechat-report.md

xhs_test:
  extends: .platform_test_template
  script:
    - |
      python scripts/run_regression_suite.py \
        --tags xhs \
        --verbose \
        --report markdown \
        --output xhs-report.md

# Generate comprehensive report
# 生成综合报告
generate_report:
  stage: report
  needs:
    - smoke_test
    - full_regression
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  script:
    - |
      python scripts/run_regression_suite.py \
        --exclude-tags manual,slow \
        --report json \
        --output comprehensive-report.json
  artifacts:
    paths:
      - comprehensive-report.json
    expire_in: 30 days

# Save baseline on main branch
# 在主分支上保存基线
save_baseline:
  stage: baseline
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  script:
    - |
      python scripts/run_regression_suite.py \
        --exclude-tags manual,slow \
        --save-baseline main
  artifacts:
    paths:
      - tests/regression/baselines/main.json
    expire_in: 90 days

# Scheduled nightly run
# 定时夜间运行
nightly_regression:
  stage: test
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - |
      python scripts/run_regression_suite.py \
        --exclude-tags manual \
        --baseline baselines/main.json \
        --fail-on-regression \
        --report markdown \
        --output nightly-report.md
  artifacts:
    paths:
      - nightly-report.md
    expire_in: 90 days
    when: always
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Performance check
# 性能检查
performance_check:
  stage: test
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  script:
    - |
      python scripts/run_regression_suite.py \
        --tags fast \
        --baseline baselines/main.json \
        --min-duration 0.1 \
        --report json \
        --output performance.json
  artifacts:
    reports:
      performance: performance.json
    expire_in: 30 days
