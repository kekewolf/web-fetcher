# Dockerfile for Web Fetcher Regression Tests
# Web Fetcher 回归测试的 Dockerfile
#
# Build: docker build -f tests/regression/examples/Dockerfile.regression -t webfetcher-regression .
# Run: docker run --rm webfetcher-regression --tags fast

FROM python:3.9-slim

# Metadata
LABEL maintainer="Web Fetcher Team"
LABEL description="Containerized regression testing for Web Fetcher"
LABEL version="1.0.0"

# Set working directory
WORKDIR /app

# Install system dependencies
# 安装系统依赖
RUN apt-get update && apt-get install -y \
    wget \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements first for better caching
# 首先复制 requirements 以便更好地缓存
COPY requirements.txt .

# Install Python dependencies
# 安装 Python 依赖
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
# 复制应用程序代码
COPY webfetcher.py .
COPY tests/ tests/
COPY scripts/ scripts/

# Create directories for outputs
# 创建输出目录
RUN mkdir -p /app/reports /app/baselines

# Set environment variables
# 设置环境变量
ENV PYTHONUNBUFFERED=1
ENV PYTHONPATH=/app

# Create non-root user for security
# 创建非 root 用户以提高安全性
RUN useradd -m -u 1000 regtest && \
    chown -R regtest:regtest /app

USER regtest

# Default command: run fast tests
# 默认命令：运行快速测试
ENTRYPOINT ["python", "scripts/run_regression_suite.py"]
CMD ["--tags", "fast", "--report", "text"]

# Health check (optional)
# 健康检查（可选）
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python --version || exit 1

# Volume mounts for baselines and reports
# 基线和报告的卷挂载
VOLUME ["/app/baselines", "/app/reports"]

# Example usage:
# 示例用法：
#
# Build image:
# 构建镜像：
#   docker build -f tests/regression/examples/Dockerfile.regression -t webfetcher-regression .
#
# Run fast tests:
# 运行快速测试：
#   docker run --rm webfetcher-regression --tags fast
#
# Run with baseline comparison:
# 运行基线比较：
#   docker run --rm \
#     -v $(pwd)/tests/regression/baselines:/app/baselines \
#     webfetcher-regression \
#     --baseline baselines/main.json --tags fast
#
# Generate markdown report:
# 生成 markdown 报告：
#   docker run --rm \
#     -v $(pwd)/reports:/app/reports \
#     webfetcher-regression \
#     --tags fast --report markdown --output /app/reports/regression.md
#
# Save baseline:
# 保存基线：
#   docker run --rm \
#     -v $(pwd)/tests/regression/baselines:/app/baselines \
#     webfetcher-regression \
#     --tags fast --save-baseline docker-v1
